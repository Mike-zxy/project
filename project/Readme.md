# project4 sm3 的软件实现与优化

## 1. sm3的实现及测试


### 1.1 初始化状态向量 `IV`

```c
IV[0] = 0x7380166F;
IV[1] = 0x4914B2B9;
...
IV[7] = 0x79CC4519;
```

* 8 个 32 位常量组成初始状态寄存器。

---

### 1.2 消息填充（`sm3_pad` 函数）

* 按照标准，在消息尾部追加 `1` 位、`k` 个 `0` 和 64 位原始长度，使总长度为 512 的倍数。
* 此部分实现一般使用一个缓冲区完成。

---

### 1.3 消息扩展（`sm3_expand` 函数）

* 原始 512 比特消息块扩展为 132 个 32 位字（W\[0..67] 与 W'\[0..63]），用于轮函数。

```c
W[j] = P1(W[j-16] ^ W[j-9] ^ (W[j-3] <<< 15)) ^ (W[j-13] <<< 7) ^ W[j-6];
```

* 置换函数 `P0`, `P1` 分别定义在对应函数或宏中。

---

### 1.4 压缩函数（`sm3_compress` 函数）

* 执行 64 轮类似 SHA256 的非线性压缩，状态变量 A\~H 每轮更新一次：

```c
SS1 = ((A <<< 12) + E + (Tj <<< (j mod 32))) <<< 7;
TT1 = FF(A, B, C, j) + D + SS2 + W'[j];
TT2 = GG(E, F, G, j) + H + SS1 + W[j];
```

* 每轮使用布尔函数 `FF` 和 `GG`（根据轮数不同而变化）。

---

### 1.5 消息摘要输出

* 所有消息块处理完后，将最终 `V_i` 与之前的 `V_{i-1}` 进行异或，得到最终结果（256 位哈希值）。

```c
V[i] = V[i-1] ^ compression(V[i-1], B_i)
```

---

### 1.6 sm3实现及测试

运行 sm3 会输出如下内容：
包括正确性验证（使用 "abc"）和性能测试（对 1MB 数据重复多次哈希）

<img width="1712" height="346" alt="image" src="https://github.com/user-attachments/assets/e5400025-c444-462e-87ba-e04b58c1784f" />

可见sm3生成的内容和预期一致


## 2. sm3的优化的实现及测试


##  优化说明（sm3_pro.c 相对于 sm3.c 的改进点）

优化版本 `sm3_pro.c`  `sm3.c` 做了如下关键优化，以提升哈希计算性能：

### 1. **函数内联与合并**

* **优化内容**：将频繁调用的小函数（如布尔函数 `FF`, `GG`、置换函数 `P0`, `P1`）全部内联，避免函数调用开销。
* **效果**：减少指令跳转，提高局部性和执行效率。

---

### 2. **轮函数展开（Loop Unrolling）**

* **优化内容**：SM3 的 64 轮压缩循环展开为显式的语句块（部分或全部），降低循环控制成本。
* **效果**：减少循环变量的计算及判断，提升整体吞吐性能。

---

### 3. **状态变量使用寄存器优化**

* **优化内容**：将中间变量如 `A, B, C, ..., H` 优化为局部变量并尽量让编译器分配到寄存器。
* **效果**：减少内存访问，提升运算速度。

---

### 4. **预计算常量与宏定义**

* **优化内容**：将 `T_j` 常量预先计算好并放入数组，使用宏代替函数逻辑。
* **效果**：加速计算并便于编译器优化路径。

---

### 5. **减少内存复制操作**

* **优化内容**：在数据填充和消息扩展过程中使用连续内存操作，避免不必要的拷贝和多余缓冲。
* **效果**：提升处理大数据块的效率。

---

### 6. **循环合并**

* **优化内容**：消息扩展与轮函数压缩过程中，一些可以合并执行的步骤合并为一个循环或连续块。
* **效果**：减少内存访问与循环逻辑判断。

---

### 7.sm3的优化的实现和测试

运行 sm3_pro 会输出如下内容：
包括正确性验证（使用 "abc"）和性能测试（对 1MB 数据重复多次哈希)

<img width="1688" height="365" alt="image" src="https://github.com/user-attachments/assets/1c50422b-1a0a-420b-aa79-c5295dfd333b" />



## 🆚 性能比较

| 测试项       | 标准版 sm3.c | 优化版 sm3\_pro.c |
| --------- | --------- | -------------- |
| 吞吐率（MB/s） | 76.63 MB/s | 98.04 MB/s      |
| 函数结构      | 模块清晰      | 高度压缩           |
| 时间       | 1.30s         | 1.02s          |

可见sm3的优化版本在时间和吞吐率上提升接近30%。
---
